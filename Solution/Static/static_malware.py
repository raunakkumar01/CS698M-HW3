import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import os
# Writing to an excel  
# sheet using Python 
import xlwt 
import re
import csv
from xlwt import Workbook

features = ['Machine', 'SizeOfOptionalHeader', 'Characteristics', 'MajorLinkerVersion', 'MinorLinkerVersion', 'SizeOfCode', 'SizeOfInitializedData', 'SizeOfUninitializedData', 'AddressOfEntryPoint', 'BaseOfCode', 'BaseOfData', 'ImageBase', 'SectionAlignment', 'FileAlignment', 'MajorOperatingSystemVersion', 'MinorOperatingSystemVersion', 'MajorImageVersion', 'MinorImageVersion', 'MajorSubsystemVersion', 'MinorSubsystemVersion', 'SizeOfImage', 'SizeOfHeaders', 'CheckSum', 'Subsystem', 'DllCharacteristics', 'SizeOfStackReserve', 'SizeOfStackCommit', 'SizeOfHeapReserve', 'SizeOfHeapCommit', 'LoaderFlags', 'NumberOfRvaAndSizes', 'SectionsNb', 'SectionsMeanEntropy', 'SectionsMinEntropy', 'SectionsMaxEntropy', 'SectionsMeanRawsize', 'SectionsMinRawsize', 'SectionMaxRawsize', 'SectionsMeanVirtualsize', 'SectionsMinVirtualsize', 'SectionMaxVirtualsize', 'ImportsNbDLL', 'ImportsNb', 'ImportsNbOrdinal', 'ExportNb', 'ResourcesNb', 'ResourcesMeanEntropy', 'ResourcesMinEntropy', 'ResourcesMaxEntropy', 'ResourcesMeanSize', 'ResourcesMinSize', 'ResourcesMaxSize', 'LoadConfigurationSize', 'VersionInformationSize']
# findSize = ['SizeOfOptionalHeader','SizeOfStackReserve','SizeOfStackCommit','SizeOfHeapReserve','SizeOfHeapCommit','SizeOfCode','SizeOfInitializedData','SizeOfUninitializedData','SizeOfImage','SizeOfHeaders']
# peSize = ['Misc_VirtualSize','SizeOfRawData','NumberOfRelocations','NumberOfLinenumbers']#Data for each PE header file *4
# print(features)
###########################################Malware########################################333
api_all_m = []#dictionary for all apis
file_list = []
def get_files(path):
	dir_entries = os.listdir(path)
	for entry in dir_entries:
		sub_dir = os.listdir(path+entry+'/')
		if(len(sub_dir)>0):
			for file in sub_dir:
				file_list.append(path+entry+'/'+file+'/Structure_Info.txt')

get_files('Malware/')

mal = []

for file in range(3):#len(file_list)):
    with open(file_list[file],"rt",encoding='latin-1') as f:
        all_data = f.read()
        data = re.split(r'\-+[a-zA-Z _]+\-+',all_data)#f.read())
        #data 1:DOS_HEADER 3:FILE_HEADER 4:OPTIONAL_HEADER 5:PE Sections 8:Imported symbols
        feature = set(features)
        mal_dic ={}
        ######################For API##############################
#         api = {}#dictionary for each api corresponding file
#         api_m =[]
#         data_api = re.split(r'IMAGE_IMPORT_DESCRIPTOR',data[8])
#         for e in range(1,len(data_api)):#for 5 blocks 6 elements created therefore start from index 1
#             val = re.findall(r'[a-zA-Z0-9.]*.dll[a-zA-Z.]*',data_api[e])
#             for v in val:
#                 if(len(v.split("."))>2):
#                     api_m.append(v.split(".")[2])
#                     if v.split(".")[2] in api:
#                         api[v.split(".")[2]] += 1
#                     else:
#                         api[v.split(".")[2]]  = 1
#         api_m.append(api) 
        api = {}#dictionary for each api corresponding file
        api_m = ""
        val = re.findall(r'[a-zA-Z0-9.]*.dll[a-zA-Z.]*',all_data)
        for v in val:
            if(len(v.split("."))>2):
                api_m = " ".join([api_m.strip(),(v.split(".")[2].strip())])
                if v.split(".")[2] in api:
                    api[v.split(".")[2]] += 1
                else:
                    api[v.split(".")[2]]  = 1
        ######################For PE###############################
#         data_pe = re.split(r'IMAGE_SECTION_HEADER',data[5])
#         for e in range(1,len(data_pe)):#for 5 blocks 6 elements created therefore start from index 1
#             print(data_pe[e]+"\n$$$AA$")
        ######################For All The Features Data###########
#         print(len(feature))
        for e in features:
            rx = "[0-9A-Zx]+\s+[0-9A-Zx]+\s+"+e+":\s+[0-9A-Zx]+"
            pat = re.compile(e,re.IGNORECASE)
            if pat.search(all_data):
                line = re.findall(rx,all_data,re.S)
#                 feature.remove(e)
                val = 0
                val+= int((line[0].split())[3], 16)
                mal_dic[e] = val
        new_dic = {}
        new_dic['Name'] = f.name
        new_dic['PredictedLabel'] = 'M'
        new_dic.update(mal_dic)
#         new_dic.update(api)
        
        
        mal.append(new_dic)
        if api_m.strip():
            api_all_m.append(api_m.strip())
#         print(api_m)

# print(len(api_all_x))

df_mal_fet = pd.DataFrame(mal)
df_api_mal = pd.DataFrame(api_all_m)
print(df_api_mal)
df_mal_fet.to_csv(r'file_mal_feat_1.csv',index=False)
df_api_mal.to_csv(r'file_mal_api_1.csv',index=False)

